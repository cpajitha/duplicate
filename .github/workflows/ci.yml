name: CI Pipeline

on: 
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10.0"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Log in to Docker Hub
        shell: powershell
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $env:DOCKER_PASSWORD | docker login --username $env:DOCKER_USERNAME --password-stdin

      - name: Build Docker image
        run: docker build -t cpajitha/fastapi_app:${{ github.sha }} .

      - name: Push Docker image to Docker Hub
        run: |
          docker tag cpajitha/fastapi_app:${{ github.sha }} cpajitha/fastapi_app:latest
          docker push cpajitha/fastapi_app:${{ github.sha }}
          docker push cpajitha/fastapi_app:latest

      - name: Run Docker container
        run: docker run -d --name fastapi_container -p 8000:8000 cpajitha/fastapi_app:${{ github.sha }}

      - name: Wait for FastAPI Server in Docker container
        shell: powershell
        run: |
          $retries = 10
          $delay = 3
          for ($i = 0; $i -lt $retries; $i++) {
              try {
                  Invoke-WebRequest -Uri "http://127.0.0.1:8000/docs" -UseBasicParsing
                  Write-Host "✅ FastAPI server is up!"
                  exit 0
              } catch {
                  Write-Host "⏳ FastAPI server not available yet. Retrying in $delay seconds..."
                  Start-Sleep -Seconds $delay
              }
          }
          Write-Host "❌ FastAPI server failed to start."
          exit 1

      - name: Run pytest tests
        run: pytest -v testing_with_pytest.py
      
      - name: Run unittest tests
        run: python testing_with_unittest.py

      - name: Install Chrome for Selenium
        run: |
          choco install googlechrome -y
          choco install chromedriver -y
        shell: powershell

      - name: Run Selenium tests
        run: python testing_with_selenium.py

      - name: Stop and Remove Docker container
        if: always()
        run: |
          docker stop fastapi_container
          docker rm fastapi_container         
